import{_ as n,o as s,c as a,e as t}from"../app.2fb2eae3.mjs";const p={},e=t(`<h1 id="\u6743\u9650\u9A8C\u8BC1\u4E2D\u95F4\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u6743\u9650\u9A8C\u8BC1\u4E2D\u95F4\u4EF6" aria-hidden="true">#</a> \u6743\u9650\u9A8C\u8BC1\u4E2D\u95F4\u4EF6</h1><p>\u4F4D\u7F6E\uFF1Aapp/core/cmd/api/internal/middleware/permmenuauthmiddleware.go</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> middleware

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;strings&quot;</span>

	<span class="token string">&quot;ark-admin-zero/common/config&quot;</span>
	<span class="token string">&quot;ark-admin-zero/common/errorx&quot;</span>
	<span class="token string">&quot;ark-admin-zero/common/utils&quot;</span>

	<span class="token string">&quot;github.com/zeromicro/go-zero/core/stores/redis&quot;</span>
	<span class="token string">&quot;github.com/zeromicro/go-zero/rest/httpx&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> PermMenuAuthMiddleware <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Redis <span class="token operator">*</span>redis<span class="token punctuation">.</span>Redis
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewPermMenuAuthMiddleware</span><span class="token punctuation">(</span>r <span class="token operator">*</span>redis<span class="token punctuation">.</span>Redis<span class="token punctuation">)</span> <span class="token operator">*</span>PermMenuAuthMiddleware <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>PermMenuAuthMiddleware<span class="token punctuation">{</span>
		Redis<span class="token punctuation">:</span> r<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>PermMenuAuthMiddleware<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">)</span> http<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			userId <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">GetUserId</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			online<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>Redis<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>SysOnlineUserCachePrefix <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> online <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
				httpx<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> errorx<span class="token punctuation">.</span><span class="token function">NewDefaultError</span><span class="token punctuation">(</span>errorx<span class="token punctuation">.</span>AuthErrorCode<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">var</span> erring any
				erring <span class="token operator">=</span> <span class="token string">&quot;Auth fail&quot;</span>
				<span class="token function">panic</span><span class="token punctuation">(</span>erring<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

			uri <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>RequestURI<span class="token punctuation">,</span> <span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span>
			is<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>Redis<span class="token punctuation">.</span><span class="token function">Sismember</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>SysPermMenuCachePrefix<span class="token operator">+</span>strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uri<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> is <span class="token operator">!=</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
				httpx<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> errorx<span class="token punctuation">.</span><span class="token function">NewDefaultError</span><span class="token punctuation">(</span>errorx<span class="token punctuation">.</span>NotPermMenuErrorCode<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">next</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),o=[e];function c(i,u){return s(),a("div",null,o)}const r=n(p,[["render",c],["__file","middleware.html.vue"]]);export{r as default};
